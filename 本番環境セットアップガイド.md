# 本番環境セットアップガイド

**対象者:** 本番環境を構築する管理者（非エンジニア向け）
**所要時間:** 約3時間
**前提条件:** Googleアカウントを持っている
**サポート:** 不明点があればプロボノエンジニアに相談

---

## 📋 チェックリスト

本番環境セットアップの進捗を確認できるチェックリストです。

### Phase 1: Googleサービス準備（90分）
- [x] 本番用Googleアカウントの準備
- [x] Google Spreadsheet作成
- [x] シート名を「フォームの回答 2」に変更
- [x] Spreadsheet IDをメモ
- [x] Google Calendar作成
- [x] Calendar IDをメモ

### Phase 2: Google Apps Script デプロイ（60分）
- [x] Google Apps Scriptプロジェクト作成
- [x] code.gsのコードをコピー&ペースト
- [x] スクリプトプロパティ設定（SPREADSHEET_ID）
- [x] スクリプトプロパティ設定（CALENDAR_ID）
- [x] スクリプトプロパティ設定（RECEPTION_URL - 任意）
- [x] ウェブアプリとしてデプロイ
- [x] デプロイURLをメモ

### Phase 3: GitHub Pages デプロイ（45分）
- [x] GitHubアカウント作成（既存がある場合はスキップ）
- [x] リポジトリをフォーク
- [x] pages/script.jsのGAS_WEB_APP_URLを更新
- [x] 変更をコミット&プッシュ
- [ ] GitHub Pages有効化
- [ ] Pages URLをメモ

### Phase 4: 動作確認（25分）
- [ ] フォームにアクセス
- [ ] テスト予約を送信
- [ ] Spreadsheetにデータが保存されていることを確認
- [ ] Calendarにイベントが作成されていることを確認
- [ ] エラーが表示されないことを確認

---

## Phase 1: Googleサービス準備（90分）

### ステップ 1-1: 本番用Googleアカウントの準備（10分）

**推奨事項:**
- 個人用アカウントではなく、施設専用のGoogleアカウントを使用
- 例: `triforce.koenji@gmail.com`

**既存アカウントを使用する場合:**
- 現在ログイン中のGoogleアカウントを使用できます
- ただし、複数の管理者がアクセスする場合は専用アカウントを推奨

**新規アカウントを作成する場合:**
1. https://accounts.google.com/signup にアクセス
2. 必要事項を入力してアカウント作成
3. 作成したアカウントでログイン

---

### ステップ 1-2: Google Spreadsheet 作成（30分）

**目的:** 予約データを保存するデータベースとして使用

#### 手順:

1. **Spreadsheet作成**
   - https://sheets.google.com/ にアクセス
   - 「新しいスプレッドシートを作成」→「空白のスプレッドシート」をクリック
   - タイトルを「Tri-force Koenji 予約データ」に変更

2. **シート名の変更**
   - 左下のシート名（デフォルト「シート1」）を右クリック
   - 「名前を変更」をクリック
   - **重要:** 必ず「フォームの回答 2」に変更してください
   - この名前はシステムが参照するため、正確に入力する必要があります

3. **列見出しの設定（任意だが推奨）**

   1行目に以下の列見出しを入力すると、後でデータを確認しやすくなります：

   | A列 | B列 | C列 | D列 | E列 | F列 |
   |-----|-----|-----|-----|-----|-----|
   | タイムスタンプ | メールアドレス | 予約施設 | 氏名 | 連絡先 | 利用開始日 |

   | G列 | H列 |
   |-----|-----|
   | 利用開始時間 | 予約ID |

   **注意:** システムは自動的にデータを追加するため、列見出しがなくても動作します

4. **Spreadsheet ID の取得**

   URLから Spreadsheet ID をコピーしてメモ帳に保存します。

   ```
   https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit
                                        ↑この部分をコピー
   ```

   **例:**
   ```
   URL: https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit
   SPREADSHEET_ID: 1a2b3c4d5e6f7g8h9i0j
   ```

   **メモ例:**
   ```
   SPREADSHEET_ID: 1a2b3c4d5e6f7g8h9i0j
   ```

5. **共有設定の確認（任意）**

   他の管理者もアクセスできるようにする場合：
   - 右上の「共有」ボタンをクリック
   - ユーザーまたはグループを追加
   - 権限を「編集者」に設定
   - 「送信」をクリック

---

### ステップ 1-3: Google Calendar 作成（30分）

**目的:** 予約を視覚的に表示し、会員と共有

#### 手順:

1. **Calendar作成**
   - https://calendar.google.com/ にアクセス
   - 左側のメニューで「他のカレンダー」の横の「+」をクリック
   - 「新しいカレンダーを作成」をクリック

2. **カレンダー情報の入力**
   - **名前:** Tri-force Koenji 予約
   - **説明:** フィットネスルームとフリーマットの予約カレンダー（任意）
   - **タイムゾーン:** (GMT+09:00) 日本時間
   - 「カレンダーを作成」をクリック

3. **カレンダー設定**

   作成したカレンダーの設定画面が開きます：

   - **「アクセス権限」セクション:**
     - 「一般公開して誰でも利用できるようにする」にチェック（会員が閲覧できるように）
     - 権限: 「予定の時間枠のみを表示（詳細を非表示）」または「すべての予定の詳細を表示」

   **注意:** 「一般公開」にすると誰でもカレンダーを閲覧できます。会員のみに限定したい場合は、特定のユーザーまたはグループのみに共有してください。

4. **Calendar ID の取得**

   カレンダー設定画面を下にスクロールして「カレンダーの統合」セクションを探します：

   - **「カレンダーID」** の欄にメールアドレス形式のIDが表示されます
   - このIDをコピーしてメモ帳に保存

   **例:**
   ```
   CALENDAR_ID: abc123def456@group.calendar.google.com
   ```

5. **カレンダーの表示確認**

   - 左側のメニューで作成したカレンダーにチェックが入っていることを確認
   - カレンダービューに「Tri-force Koenji 予約」が表示されていればOK

---

### ステップ 1-4: メモの整理（10分）

ここまでで以下の2つの情報を取得しました。次のステップで使用するため、メモ帳やテキストファイルに整理して保存してください。

**取得した情報:**

```
SPREADSHEET_ID: [ステップ1-2で取得したID]
CALENDAR_ID: [ステップ1-3で取得したID]
```

**例:**
```
SPREADSHEET_ID: 1a2b3c4d5e6f7g8h9i0j
CALENDAR_ID: abc123def456@group.calendar.google.com
```

**保存場所の推奨:**
- パスワード管理ツール（1Password, LastPass など）
- セキュアなメモアプリ
- オフラインのテキストファイル（USBメモリなどに保存）

---

## Phase 2: Google Apps Script デプロイ（60分）

### ステップ 2-1: Google Apps Script プロジェクト作成（10分）

1. **Apps Script エディタを開く**
   - https://script.google.com/ にアクセス
   - ログインを求められた場合は、Phase 1で使用したGoogleアカウントでログイン

2. **新しいプロジェクトを作成**
   - 左上の「新しいプロジェクト」をクリック
   - エディタ画面が開きます

3. **プロジェクト名を変更**
   - 左上の「無題のプロジェクト」をクリック
   - プロジェクト名を「Tri-force Koenji 予約システム」に変更
   - 「名前を変更」をクリック

---

### ステップ 2-2: code.gs のコードをコピー（15分）

1. **既存のコードを削除**
   - エディタに表示されているデフォルトのコード（`function myFunction() {...}`）を全て削除

2. **code.gs のコードを取得**

   リポジトリから `code.gs` ファイルを開きます：

   - GitHubリポジトリのページを開く
   - `code.gs` ファイルをクリック
   - 「Raw」ボタンをクリック
   - 表示されたコード全体をコピー（Ctrl+A → Ctrl+C）

3. **コードを貼り付け**
   - Apps Scriptエディタに戻る
   - コピーしたコードを貼り付け（Ctrl+V）
   - 左上の「保存」アイコン（フロッピーディスク）をクリック

4. **コードの確認**

   以下の関数が含まれていることを確認：
   - `doPost(e)` - フォームデータを受け取る関数
   - `processFormDataForApi(formData)` - 予約処理
   - `saveToSpreadsheet(data)` - Spreadsheetに保存
   - `createCalendarEvent(data)` - Calendarイベント作成
   - など

---

### ステップ 2-3: スクリプトプロパティ設定（20分）

**重要:** スクリプトプロパティは機密情報を安全に保存する仕組みです。コードに直接IDを書き込まないでください。

#### 手順:

1. **プロジェクト設定を開く**
   - 左側のメニューで「プロジェクトの設定」（歯車アイコン）をクリック

2. **スクリプトプロパティセクションへ移動**
   - 下にスクロールして「スクリプト プロパティ」セクションを探す
   - 「スクリプト プロパティを追加」ボタンをクリック

3. **SPREADSHEET_ID を追加**

   - **プロパティ:** `SPREADSHEET_ID`（正確に入力）
   - **値:** Phase 1-2 で取得した Spreadsheet ID を貼り付け
   - 「スクリプト プロパティを追加」をクリック

4. **CALENDAR_ID を追加**

   - 再度「スクリプト プロパティを追加」ボタンをクリック
   - **プロパティ:** `CALENDAR_ID`（正確に入力）
   - **値:** Phase 1-3 で取得した Calendar ID を貼り付け
   - 「スクリプト プロパティを追加」をクリック

5. **RECEPTION_URL を追加（任意）**

   予約完了後にリダイレクトするURLを設定できます（任意）。設定しない場合はスキップしてください。

   - 再度「スクリプト プロパティを追加」ボタンをクリック
   - **プロパティ:** `RECEPTION_URL`
   - **値:** リダイレクト先URL（例: `https://triforce-koenji.com/thank-you`）
   - 「スクリプト プロパティを追加」をクリック

6. **設定の確認**

   スクリプトプロパティに以下が表示されていることを確認：

   | プロパティ | 値 |
   |-----------|---|
   | SPREADSHEET_ID | 1a2b3c4d5e6f7g8h9i0j |
   | CALENDAR_ID | abc123def456@group.calendar.google.com |
   | RECEPTION_URL | （任意） |

---

### ステップ 2-4: ウェブアプリとしてデプロイ（15分）

1. **デプロイ画面を開く**
   - 右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」を選択

2. **デプロイタイプの選択**
   - 「種類の選択」（歯車アイコン）をクリック
   - 「ウェブアプリ」を選択

3. **デプロイ設定**

   以下の設定を入力：

   - **説明:** 本番環境（任意だが推奨）
   - **次のユーザーとして実行:** 自分（`your-email@gmail.com`）
   - **アクセスできるユーザー:** **全員**

   **重要:** 「アクセスできるユーザー」は必ず「全員」に設定してください。これにより、誰でも予約フォームから送信できるようになります。

4. **承認プロセス**

   初回デプロイ時は承認が必要です：

   - 「デプロイ」ボタンをクリック
   - 「アクセスを承認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「Tri-force Koenji 予約システム（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

5. **デプロイURLの取得**

   デプロイが完了すると、以下の情報が表示されます：

   - **デプロイ ID:** `AKfycby...`（内部的に使用）
   - **ウェブアプリ URL:** `https://script.google.com/macros/s/AKfycby.../exec`

   **重要:** 「ウェブアプリ URL」をコピーしてメモ帳に保存してください。

   **メモ例:**
   ```
   GAS_WEB_APP_URL: https://script.google.com/macros/s/AKfycbyXXXXXXXXXXXX/exec
   ```

6. **デプロイの確認**

   - コピーしたURLをブラウザに貼り付けてアクセス
   - 何かエラーが表示される場合は正常です（GETリクエストには対応していないため）
   - 「Service invoked too many times」などのエラーではなく、「Method not allowed」や空白ページなら正常

---

## Phase 3: GitHub Pages デプロイ（45分）

### ステップ 3-1: GitHubアカウント作成（10分）※既にある場合はスキップ

1. https://github.com/ にアクセス
2. 「Sign up」をクリック
3. 必要事項を入力してアカウント作成
4. メール認証を完了

---

### ステップ 3-2: リポジトリをフォーク（5分）

1. **元のリポジトリにアクセス**
   - プロボノエンジニアから共有されたリポジトリURLを開く
   - 例: `https://github.com/[元のユーザー名]/tri-force-koenji-reservation`

2. **フォーク**
   - 右上の「Fork」ボタンをクリック
   - 「Create fork」をクリック
   - 自分のアカウントにリポジトリがコピーされます

---

### ステップ 3-3: docs/script.js の GAS URL を更新（15分）

**重要:** ファイル名は `docs/script.js` です（GitHub Pagesの制約により `/docs` フォルダのみ選択可能なため）

**方法1: GitHub Web エディタを使用（推奨）**

1. **ファイルを開く**
   - フォークしたリポジトリのページで `docs/script.js` をクリック
   - 右上の鉛筆アイコン（編集）をクリック

2. **GAS_WEB_APP_URL を更新**

   9行目付近にある以下の行を探します：

   ```javascript
   const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjUmQrTpVqtiEWHk9OsBplx7gMy9bjHRqNMOsJAUvt9aWkvYVEP9GE7NNGYPNn8sQ/exec';
   ```

   この URL を Phase 2-4 で取得した自分の GAS Web App URL に置き換えます：

   ```javascript
   const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/[あなたのSCRIPT_ID]/exec';
   ```

3. **変更をコミット**

   - 下にスクロールして「Commit changes」ボタンをクリック
   - コミットメッセージ: 「設定: GAS Web App URLを本番環境用に更新」
   - 「Commit directly to the main branch」を選択
   - 「Commit changes」をクリック

**方法2: ローカルでGit操作（エンジニア向け）**

エンジニアサポートがある場合は、以下の方法も可能です：

```bash
git clone https://github.com/[あなたのユーザー名]/tri-force-koenji-reservation.git
cd tri-force-koenji-reservation
# docs/script.js を編集
git add docs/script.js
git commit -m "設定: GAS Web App URLを本番環境用に更新"
git push origin main
```

---

### ステップ 3-4: GitHub Pages 有効化（10分）

1. **Settings を開く**
   - リポジトリのページで「Settings」タブをクリック

2. **Pages 設定へ移動**
   - 左側のメニューで「Pages」をクリック

3. **Source 設定**

   - **Branch:** `main` を選択
   - **Folder:** `/docs` を選択（重要！）
   - 「Save」をクリック

   **注意:** GitHub Pagesは `/root`、`/docs`、またはGitHub Actionsの3つのオプションのみサポートしています。プロジェクトでは `/docs` を使用します。

4. **デプロイ完了を待つ**

   - 「Your site is live at ...」というメッセージが表示されます
   - 数分かかる場合があります
   - ページを更新すると進捗を確認できます

5. **Pages URL の取得**

   デプロイが完了すると、以下のようなURLが表示されます：

   ```
   https://[あなたのユーザー名].github.io/tri-force-koenji-reservation/
   ```

   このURLをメモ帳に保存してください。これが本番環境の予約フォームURLです。

---

### ステップ 3-5: カスタムドメイン設定（任意・20分）

独自ドメイン（例: `https://reserve.triforce-koenji.com`）を使用する場合：

1. **ドメインを取得**
   - お名前.com、ムームードメインなどでドメインを取得

2. **DNS設定**

   ドメイン管理画面でDNSレコードを追加：

   ```
   タイプ: CNAME
   ホスト: reserve（またはwww）
   値: [あなたのユーザー名].github.io
   ```

3. **GitHub Pages でカスタムドメイン設定**

   - Settings → Pages → Custom domain
   - 取得したドメインを入力（例: `reserve.triforce-koenji.com`）
   - 「Save」をクリック

4. **HTTPS を有効化**

   - 「Enforce HTTPS」にチェックを入れる
   - DNS伝播に24-48時間かかる場合があります

---

## Phase 4: 動作確認（25分）

### ステップ 4-1: フォームアクセス確認（5分）

1. **予約フォームにアクセス**

   Phase 3-4 で取得した GitHub Pages URL を開く：
   ```
   https://[あなたのユーザー名].github.io/tri-force-koenji-reservation/
   ```

2. **表示確認**

   以下が正しく表示されることを確認：
   - [ ] ページタイトル「Tri-force Koenji 施設予約システム」
   - [ ] 予約フォーム（6つの入力項目）
   - [ ] Material Design スタイル（青と白のデザイン）
   - [ ] カレンダーアイコンが表示される

3. **エラーがないことを確認**

   - ブラウザの開発者ツールを開く（F12キー）
   - 「Console」タブをクリック
   - 赤いエラーメッセージがないことを確認

---

### ステップ 4-2: テスト予約の送信（10分）

1. **テストデータを入力**

   以下のようなテストデータを入力します：

   | 項目 | 入力内容 |
   |------|---------|
   | メールアドレス | test@example.com |
   | 予約施設 | フィットネスルーム |
   | 氏名 | テスト太郎 |
   | 連絡先 | 090-1234-5678 |
   | 利用開始日 | （明日の日付を選択） |
   | 利用開始時間 | 10:00 |

2. **送信ボタンをクリック**

   - 「送信」ボタンをクリック
   - ボタンが「送信中...」に変わることを確認
   - 数秒待つ

3. **成功メッセージの確認**

   以下のメッセージが表示されることを確認：

   ```
   ✓ 予約が正常に受け付けられました
   予約ID: YYYY-MM-DD_HH:MM_XXXX
   管理者が会員確認を行い、予約を確定いたします。
   確認の連絡をお待ちください。
   ```

4. **エラーが表示される場合**

   以下を確認してください：

   - [ ] GAS_WEB_APP_URL が正しく設定されているか（pages/script.js の9行目）
   - [ ] GAS のデプロイで「アクセスできるユーザー: 全員」になっているか
   - [ ] スクリプトプロパティが正しく設定されているか
   - [ ] ブラウザのコンソールにエラーメッセージがないか

---

### ステップ 4-3: Spreadsheet にデータが保存されていることを確認（5分）

1. **Spreadsheet を開く**
   - Phase 1-2 で作成した Google Spreadsheet を開く
   - https://sheets.google.com/ にアクセス
   - 「Tri-force Koenji 予約データ」を開く

2. **データ確認**

   「フォームの回答 2」シートに新しい行が追加されていることを確認：

   | タイムスタンプ | メールアドレス | 予約施設 | 氏名 | 連絡先 | 利用開始日 | 利用開始時間 | 予約ID |
   |--------------|--------------|---------|-----|--------|-----------|-------------|--------|
   | 2025-XX-XX XX:XX:XX | test@example.com | フィットネスルーム | テスト太郎 | 090-1234-5678 | 2025-XX-XX | 10:00 | 2025-XX-XX_10:00_XXXX |

3. **データが保存されていない場合**

   Google Apps Script のログを確認：

   - https://script.google.com/ を開く
   - 「Tri-force Koenji 予約システム」プロジェクトを開く
   - 左側のメニューで「実行数」をクリック
   - 最新の実行ログを確認
   - エラーメッセージがあれば、その内容をプロボノエンジニアに連絡

---

### ステップ 4-4: Calendar にイベントが作成されていることを確認（5分）

1. **Calendar を開く**
   - Phase 1-3 で作成した Google Calendar を開く
   - https://calendar.google.com/ にアクセス
   - 左側のメニューで「Tri-force Koenji 予約」にチェックが入っていることを確認

2. **イベント確認**

   テスト予約で選択した日時にイベントが作成されていることを確認：

   - イベントタイトル: 「フィットネスルーム - テスト太郎」
   - 日時: テスト予約で選択した日時
   - イベントをクリックして詳細を確認

3. **イベント詳細の確認**

   イベントの説明欄に以下の情報が含まれていることを確認：

   ```
   予約者: テスト太郎
   メールアドレス: test@example.com
   連絡先: 090-1234-5678
   予約ID: 2025-XX-XX_10:00_XXXX
   ```

4. **イベントが作成されていない場合**

   - スクリプトプロパティの CALENDAR_ID が正しいか確認
   - GAS のログを確認（ステップ 4-3 の手順3を参照）

---

## ✅ セットアップ完了チェックリスト

全ての項目にチェックが入れば、本番環境セットアップは完了です！

- [ ] Google Spreadsheet にデータが保存される
- [ ] Google Calendar にイベントが作成される
- [ ] 予約フォームにアクセスできる
- [ ] 成功メッセージが表示される
- [ ] エラーが表示されない
- [ ] ブラウザのコンソールにエラーがない

---

## 🎉 次のステップ

本番環境セットアップが完了したら、以下のドキュメントを参照してください：

1. **日常の運用方法:**
   - [documentation/運用手順書.md](documentation/運用手順書.md)
   - 予約の確認、会員確認、データのバックアップ方法など

2. **管理者向けガイド:**
   - [非技術者向け_本番運用準備ガイド.md](非技術者向け_本番運用準備ガイド.md)
   - 本番運用の注意点、よくある質問など

3. **技術的な課題:**
   - [本番運用検討課題と解決案.md](本番運用検討課題と解決案.md)
   - セキュリティ、バックアップ、エラー監視などの改善案

---

## ❓ トラブルシューティング

### 問題1: 「予約に失敗しました」と表示される

**原因:**
- GAS_WEB_APP_URL が間違っている
- GAS のデプロイ設定が間違っている

**解決方法:**
1. `docs/script.js` の9行目の URL を確認
2. GAS のデプロイ設定を確認（「アクセスできるユーザー: 全員」になっているか）
3. GAS を再デプロイしてみる（「デプロイを管理」→「編集」→「バージョン: 新しいバージョン」→「デプロイ」）

---

### 問題2: データが Spreadsheet に保存されない

**原因:**
- スクリプトプロパティの SPREADSHEET_ID が間違っている
- シート名が「フォームの回答 2」になっていない

**解決方法:**
1. GAS のスクリプトプロパティを確認
2. Spreadsheet のシート名を確認
3. GAS のログを確認してエラーメッセージを確認

---

### 問題3: Calendar にイベントが作成されない

**原因:**
- スクリプトプロパティの CALENDAR_ID が間違っている
- Calendar の権限がない

**解決方法:**
1. GAS のスクリプトプロパティを確認
2. Calendar ID が正しいか確認（`@group.calendar.google.com` で終わっているか）
3. GAS のログを確認してエラーメッセージを確認

---

### 問題4: GitHub Pages が表示されない

**原因:**
- Pages の設定が間違っている
- デプロイが完了していない

**解決方法:**
1. Settings → Pages → Folder が `/pages` になっているか確認
2. 数分待ってから再度アクセス
3. ブラウザのキャッシュをクリア（Ctrl+Shift+R）

---

### 問題5: CORS エラーが表示される

**原因:**
- GAS のデプロイ設定が間違っている

**解決方法:**
1. GAS のデプロイ設定で「アクセスできるユーザー: 全員」になっているか確認
2. GAS を再デプロイしてみる

---

## 📞 サポート

不明点があれば、以下に連絡してください：

- **プロボノエンジニア:** [連絡先]
- **GitHub Issues:** https://github.com/[username]/tri-force-koenji-reservation/issues

---

**作成日:** 2025年
**最終更新:** 2025年
**対象バージョン:** MVP 1.0
**所要時間:** 約3時間
