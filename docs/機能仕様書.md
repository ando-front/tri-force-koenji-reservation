# Tri-force Koenji施設予約システム 機能仕様書

## 1. 機能概要

### 1.1 システム概要
本システムは、Tri-force Koenji会員向けの施設予約システムです。Webブラウザから簡単に施設予約を行い、Google SpreadsheetとGoogle Calendarに自動で予約情報を連携します。

### 1.2 対象ユーザー
- Tri-force Koenji会員（メールアドレス保有者）

### 1.3 対象施設
- フリーマット（最大定員：10名）
- フィットネス（最大定員：4名）

## 2. 機能詳細仕様

### 2.1 予約フォーム表示機能

#### 2.1.1 機能概要
予約フォームをWebブラウザに表示する機能

#### 2.1.2 入力項目
| 項目名 | 必須 | 入力形式 | バリデーション |
|--------|------|----------|----------------|
| メールアドレス | ○ | email | HTML5 email形式 |
| 予約施設 | ○ | radio | フリーマット/フィットネス |
| 氏名 | ○ | text | 必須入力 |
| 連絡先 | ○ | tel | 必須入力 |
| 利用開始日 | ○ | date | 過去日選択不可 |
| 利用開始時間 | ○ | select | 7:00-21:00、30分間隔 |
| 備考 | - | textarea | 任意入力 |

#### 2.1.3 UI仕様
- Materialize CSS使用
- レスポンシブデザイン
- 日本語対応
- カラーテーマ：Materialize標準

#### 2.1.4 動的UI機能
- 施設選択時の定員表示更新
- 日付選択時の時間選択肢更新
- リアルタイムバリデーション

### 2.2 予約処理機能

#### 2.2.1 機能概要
フォーム送信データを処理し、予約登録を実行する機能

#### 2.2.2 処理フロー
```
1. フォームデータ受信
2. 入力データバリデーション
3. 日時データ変換
4. 重複チェック
5. スプレッドシート保存
6. カレンダー登録
7. 結果表示
```

#### 2.2.3 バリデーション仕様
- 必須項目チェック
- 日付形式チェック
- 過去日チェック
- 営業時間チェック（7:00-21:00）

### 2.3 重複チェック機能

#### 2.3.1 機能概要
同一時間帯の予約数をチェックし、定員オーバーを防止する機能

#### 2.3.2 チェック条件
- 同一施設
- 同一日付
- 同一時間帯（1時間枠）

#### 2.3.3 定員設定
- フリーマット：10名
- フィットネス：4名

#### 2.3.4 チェック処理
```javascript
// 疑似コード
existingReservations = getReservationsFromSpreadsheet();
count = 0;
for (reservation in existingReservations) {
    if (isSameFacility && isSameDateTime) {
        count++;
    }
}
return count >= maxCapacity;
```

### 2.4 データ保存機能

#### 2.4.1 スプレッドシート保存
- 保存先：「フォームの回答 2」シート
- 保存データ：全入力項目 + タイムスタンプ

#### 2.4.2 保存データ構造
```javascript
[
    new Date(),              // タイムスタンプ
    formData.メールアドレス,
    formData.予約施設,
    formData.氏名,
    formData.連絡先,
    startTime,              // 利用開始時間(Date)
    endTime,                // 利用終了時間(Date)
    formData.備考,
    ''                      // 空欄
]
```

### 2.5 カレンダー連携機能

#### 2.5.1 機能概要
Google Calendarに予約イベントを自動作成する機能

#### 2.5.2 イベント設定
- タイトル：「予約：[氏名] 様：[施設名]」
- 開始時間：利用開始時間
- 終了時間：利用開始時間 + 1時間
- 説明：備考欄の内容

#### 2.5.3 カレンダー設定
- カレンダーID：Script Propertiesから取得
- タイムゾーン：Asia/Tokyo

### 2.6 結果表示機能

#### 2.6.1 成功時表示
- メッセージ：「予約が完了しました。」
- 色：teal（青緑）
- ボタン：「予約フォームに戻る」「カレンダーを見る」

#### 2.6.2 エラー時表示
- メッセージ：エラー内容に応じた日本語メッセージ
- 色：red（赤）またはdeep-orange（オレンジ）
- ボタン：「予約フォームに戻る」

#### 2.6.3 エラーパターン
| エラー内容 | 表示メッセージ | 色 |
|------------|----------------|-----|
| 必須項目未入力 | 「利用開始日と利用開始時間は必須です。」 | red |
| 満員 | 「この時間帯は満員です。」 | red |
| 日付変換エラー | 「日付の形式が正しくありません。」 | red |
| システムエラー | 「予約処理中にエラーが発生しました：[詳細]」 | deep-orange |

## 3. 非機能要件

### 3.1 性能要件
- フォーム表示：3秒以内
- 予約処理：5秒以内
- 同時アクセス：50ユーザー

### 3.2 互換性要件
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）
- スマートフォン対応

### 3.3 セキュリティ要件
- HTTPS通信
- 入力値サニタイズ
- SQLインジェクション対策（該当なし）

### 3.4 可用性要件
- 稼働率：99.5%以上
- Google Apps Script依存

## 4. 設定パラメータ

### 4.1 Script Properties
```javascript
SPREADSHEET_ID = "スプレッドシートID";
CALENDAR_ID = "カレンダーID";
RECEPTION_URL = "予約フォームURL";
```

### 4.2 営業時間設定
```javascript
OPERATING_START_HOUR = 7;    // 7:00
OPERATING_END_HOUR = 21;     // 21:00
TIME_SLOT_INTERVAL = 30;     // 30分間隔
RESERVATION_DURATION = 60;   // 60分利用
```

### 4.3 定員設定
```javascript
CAPACITY = {
    "フリーマット": 10,
    "フィットネス": 4
};
```

## 5. テスト仕様

### 5.1 単体テスト
- parseStartTime()：日時変換テスト
- calculateEndTime()：終了時刻計算テスト
- isSameHour()：時刻比較テスト
- isTimeSlotFull()：満員チェックテスト
- convertSpreadsheetDate()：スプレッドシート日付変換テスト

### 5.2 結合テスト
- フォーム送信〜予約完了までの一連の処理
- エラーハンドリング
- 重複チェック動作

### 5.3 画面テスト
- 各ブラウザでの表示確認
- レスポンシブデザイン確認
- JavaScript動作確認

## 6. 運用仕様

### 6.1 データバックアップ
- Google Spreadsheet：Google Drive自動バックアップ
- Google Calendar：Google Calendar自動バックアップ

### 6.2 ログ管理
- Google Apps Script Logger使用
- エラーログ：Stackdriver Logging

### 6.3 監視項目
- 予約登録成功率
- システムエラー発生率
- 応答時間

## 7. 制限事項

### 7.1 Google Apps Script制限
- 実行時間：最大6分
- 日次実行制限：あり
- 同時実行数：最大30

### 7.2 機能制限
- 予約変更機能なし
- 予約キャンセル機能なし
- 過去の予約削除機能なし

### 7.3 データ制限
- スプレッドシート：最大500万行
- カレンダー：制限なし（Google Calendar依存）

## 8. 今後の拡張計画

### 8.1 機能拡張
- 予約変更機能
- 予約キャンセル機能
- 利用履歴表示機能
- 自動リマインダー機能

### 8.2 UI/UX改善
- PWA対応
- オフライン対応
- プッシュ通知機能
