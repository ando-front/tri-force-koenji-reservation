# Tri-force Koenji施設予約システム 設計書

## 1. システム設計概要

### 1.1 システム構成
```
┌─────────────────────────────────────────────────────────────────┐
│                      Tri-force Koenji 予約システム                   │
├─────────────────────────────────────────────────────────────────┤
│                          Frontend                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   index.html                               │  │
│  │  - Materialize CSS Framework                              │  │
│  │  - JavaScript (フォームバリデーション)                      │  │
│  │  - レスポンシブデザイン                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                          Backend                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   code.gs                                 │  │
│  │  - Google Apps Script                                     │  │
│  │  - 予約処理ロジック                                       │  │
│  │  - データバリデーション                                   │  │
│  │  - 外部API連携                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                        Data Layer                                │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐  │
│  │   Google Spreadsheet    │  │     Google Calendar         │  │
│  │  - 予約データ永続化     │  │  - スケジュール管理         │  │
│  │  - フォーム回答データ   │  │  - イベント自動登録         │  │
│  └─────────────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック
- **Frontend**: HTML5, CSS3, JavaScript, Materialize CSS
- **Backend**: Google Apps Script (JavaScript)
- **Database**: Google Spreadsheet
- **Calendar**: Google Calendar API
- **Testing**: カスタムテストフレームワーク (gas-mocha-adapter)

## 2. フロントエンド設計

### 2.1 画面構成
```
┌─────────────────────────────────────────────────────────────────┐
│                      予約フォーム画面                             │
├─────────────────────────────────────────────────────────────────┤
│  ヘッダー: Tri-force Koenji会員専用サイト                         │
├─────────────────────────────────────────────────────────────────┤
│  入力フォーム:                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  メールアドレス     [________________] (必須)                │ │
│  │  予約施設          ○フリーマット ○フィットネス             │ │
│  │  氏名              [________________] (必須)                │ │
│  │  連絡先            [________________] (必須)                │ │
│  │  利用開始日        [________________] (必須)                │ │
│  │  利用開始時間      [________________] (必須)                │ │
│  │  備考              [________________] (任意)                │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ボタン:                                                        │
│  [ 送信 ]  [ カレンダーを見る ]                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 JavaScript設計
```javascript
// 主要関数構成
├── DOMContentLoaded処理
│   ├── Materialize初期化
│   ├── DatePicker設定
│   └── FormSelect設定
├── updateCapacity() - 定員数更新
├── generateTimeOptions() - 時間選択肢生成
├── バリデーション処理
│   ├── invalid イベント
│   └── input イベント
└── 日付変更処理
    ├── 過去日チェック
    └── 時間選択肢更新
```

## 3. バックエンド設計

### 3.1 関数構成
```
code.gs
├── Web App Entry Points
│   ├── doGet() - HTMLページ表示
│   └── doPost() - フォーム送信処理
├── 予約処理
│   ├── processFormData() - フォームデータ処理
│   ├── parseStartTime() - 日時変換
│   ├── calculateEndTime() - 終了時刻計算
│   └── showMessage() - メッセージ表示
├── 重複チェック
│   ├── isTimeSlotFull() - 時間帯満員チェック
│   ├── convertSpreadsheetDate() - 日付変換
│   └── isSameHour() - 同時刻判定
├── データ操作
│   ├── saveFormDataToSpreadsheet() - スプレッドシート保存
│   └── createCalendarEvent() - カレンダー登録
└── テスト実行
    └── test() - テストランナー
```

### 3.2 データフロー
```
1. ユーザーがフォーム送信
         ↓
2. doPost()でリクエスト受信
         ↓
3. processFormData()でデータ処理
         ↓
4. バリデーション実行
         ↓
5. isTimeSlotFull()で重複チェック
         ↓
6. saveFormDataToSpreadsheet()でデータ保存
         ↓
7. createCalendarEvent()でカレンダー登録
         ↓
8. showMessage()で結果表示
```

## 4. データベース設計

### 4.1 スプレッドシート構造
```
「フォームの回答 2」シート
┌─────────────┬──────────────┬──────────────┬──────────────┐
│  Column A   │   Column B   │   Column C   │   Column D   │
│  タイムスタンプ │ メールアドレス │  予約施設    │    氏名      │
├─────────────┼──────────────┼──────────────┼──────────────┤
│  Column E   │   Column F   │   Column G   │   Column H   │
│   連絡先    │ 利用開始時間  │  利用終了時間 │    備考      │
├─────────────┼──────────────┼──────────────┼──────────────┤
│  Column I   │   Column J   │              │              │
│   (空欄)    │ 利用開始時間  │              │              │
│            │ (変換後Date) │              │              │
└─────────────┴──────────────┴──────────────┴──────────────┘
```

### 4.2 設定情報 (Script Properties)
```javascript
const SPREADSHEET_ID = "スプレッドシートID";
const CALENDAR_ID = "カレンダーID";
const RECEPTION_URL = "予約フォームURL";
```

## 5. API設計

### 5.1 Google Apps Script Web App
```
エンドポイント: https://script.google.com/macros/s/{SCRIPT_ID}/exec
メソッド: GET, POST
```

#### GET /
```
機能: 予約フォーム表示
レスポンス: HTML (index.html)
```

#### POST /
```
機能: 予約登録
リクエスト: application/x-www-form-urlencoded
{
  "メールアドレス": "user@example.com",
  "予約施設": "フリーマット",
  "氏名": "田中太郎",
  "連絡先": "090-1234-5678",
  "利用開始日": "2023-12-01",
  "利用開始時間": "10:00",
  "備考": "初回利用"
}
レスポンス: HTML (結果メッセージ)
```

### 5.2 Google Calendar API
```javascript
// イベント作成
calendar.createEvent(
  eventTitle,    // '予約：氏名 様：施設名'
  startTime,     // Date オブジェクト
  endTime,       // Date オブジェクト
  options        // { description: '備考' }
);
```

## 6. セキュリティ設計

### 6.1 入力バリデーション
```javascript
// フロントエンド
- HTML5バリデーション属性
- JavaScriptリアルタイムバリデーション
- 必須フィールドチェック

// バックエンド
- 日付形式チェック
- 施設名チェック
- 過去日チェック
```

### 6.2 アクセス制御
```
- HTTPS通信
- メールアドレス必須入力
- Google Apps Script実行権限
```

## 7. テスト設計

### 7.1 テストフレームワーク
```javascript
// gas-mocha-adapter.js
├── GasMochaAdapter クラス
├── describe() 関数
├── it() 関数
└── assert() 関数
```

### 7.2 テストケース
```javascript
// main.test.gs
├── parseStartTime() テスト
│   ├── 正常な日付文字列のパース
│   └── 不正な日付文字列のエラー
├── isTimeSlotFull() テスト
│   ├── 時間帯が満員でない場合
│   └── 時間帯が満員の場合
├── convertSpreadsheetDate() テスト
│   ├── 数値からの日付変換
│   ├── 文字列からの日付変換
│   └── 不正な値の処理
└── calculateEndTime() テスト
    └── 終了時刻の正確な計算
```

## 8. エラーハンドリング設計

### 8.1 エラー分類
```javascript
// フロントエンドエラー
├── バリデーションエラー
├── ネットワークエラー
└── ブラウザ互換性エラー

// バックエンドエラー
├── 日付変換エラー
├── スプレッドシートアクセスエラー
├── カレンダー登録エラー
└── 予約満員エラー
```

### 8.2 エラー処理フロー
```
1. エラー発生
     ↓
2. try-catch でキャッチ
     ↓
3. Logger.log() でログ出力
     ↓
4. showMessage() でユーザー通知
     ↓
5. エラーページ表示
```

## 9. パフォーマンス設計

### 9.1 最適化ポイント
```javascript
// フロントエンド
- CDN使用 (Materialize CSS)
- 画像圧縮
- JavaScript最小化

// バックエンド
- スプレッドシート読み込み最適化
- 不要なAPI呼び出し削減
- キャッシュ活用
```

### 9.2 制限値
```
- Google Apps Script実行時間: 最大6分
- 同時実行数: 最大30
- スプレッドシート行数: 最大500万行
```

## 10. 運用設計

### 10.1 監視項目
```
- 予約登録成功率
- システム応答時間
- エラー発生率
- スプレッドシート容量
```

### 10.2 メンテナンス
```
- 定期的なログ確認
- スプレッドシートデータ整理
- カレンダーイベント整理
- テスト実行
```

## 11. 拡張性設計

### 11.1 今後の機能拡張
```javascript
// 予定機能
├── 予約キャンセル
├── 予約変更
├── 利用履歴表示
├── 自動リマインダー
└── 管理画面
```

### 11.2 アーキテクチャ拡張
```
- データベース分離
- API化
- 認証システム強化
- 通知システム
```
