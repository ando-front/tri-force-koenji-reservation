# Tri-force Koenji施設予約システム アーキテクチャ図

## 1. システム全体構成図

```mermaid
graph TB
    subgraph "User Interface"
        UI[Web Browser]
    end
    
    subgraph "Google Apps Script"
        GAS[Apps Script Runtime]
        HTML[HTML Service]
        PROP[Properties Service]
    end
    
    subgraph "Data Storage"
        SHEET[Google Spreadsheet]
        CAL[Google Calendar]
    end
    
    subgraph "External Services"
        MATERIALIZE[Materialize CSS CDN]
        GFONTS[Google Fonts]
    end
    
    UI --> GAS
    GAS --> HTML
    GAS --> PROP
    GAS --> SHEET
    GAS --> CAL
    HTML --> MATERIALIZE
    HTML --> GFONTS
```

## 2. 機能構成図

```mermaid
graph LR
    subgraph "Frontend Functions"
        FF1[Form Validation]
        FF2[Dynamic UI Updates]
        FF3[Time Slot Generation]
        FF4[Date Picker]
    end
    
    subgraph "Backend Functions"
        BF1[Form Processing]
        BF2[Data Validation]
        BF3[Duplicate Check]
        BF4[Calendar Integration]
        BF5[Spreadsheet Operations]
    end
    
    subgraph "Utility Functions"
        UF1[Date Conversion]
        UF2[Time Calculation]
        UF3[Error Handling]
        UF4[Message Display]
    end
    
    FF1 --> BF1
    FF2 --> BF2
    FF3 --> BF3
    BF1 --> UF1
    BF2 --> UF2
    BF3 --> UF3
    BF4 --> UF4
    BF5 --> UF4
```

## 3. データフロー図

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant S as Spreadsheet
    participant C as Calendar
    
    U->>F: Fill Form
    F->>F: Validate Input
    F->>B: Submit Form Data
    B->>B: Process Data
    B->>S: Check Availability
    S->>B: Return Status
    
    alt Time Slot Available
        B->>S: Save Reservation
        B->>C: Create Event
        C->>B: Event Created
        B->>F: Success Message
    else Time Slot Full
        B->>F: Error Message
    end
    
    F->>U: Display Result
```

## 4. クラス構成図

```mermaid
classDiagram
    class ReservationSystem {
        +doGet()
        +doPost()
        +processFormData()
        +showMessage()
    }
    
    class TimeSlotManager {
        +isTimeSlotFull()
        +parseStartTime()
        +calculateEndTime()
        +isSameHour()
    }
    
    class DataManager {
        +saveFormDataToSpreadsheet()
        +convertSpreadsheetDate()
    }
    
    class CalendarManager {
        +createCalendarEvent()
    }
    
    class TestAdapter {
        +GasMochaAdapter()
        +run()
        +addTest()
        +getSummary()
    }
    
    ReservationSystem --> TimeSlotManager
    ReservationSystem --> DataManager
    ReservationSystem --> CalendarManager
    TestAdapter --> ReservationSystem
```

## 5. 状態遷移図

```mermaid
stateDiagram-v2
    [*] --> FormDisplay
    FormDisplay --> FormValidation : User Input
    FormValidation --> FormValidation : Validation Error
    FormValidation --> Processing : Valid Input
    Processing --> AvailabilityCheck : Data Processed
    AvailabilityCheck --> Success : Available
    AvailabilityCheck --> Error : Full
    Success --> DataSave : Process
    DataSave --> CalendarCreate : Saved
    CalendarCreate --> Complete : Event Created
    Complete --> [*]
    Error --> FormDisplay : Show Error
```

## 6. エラーハンドリング構成

```mermaid
graph TD
    INPUT[User Input] --> VALIDATE{Validation}
    VALIDATE -->|Valid| PROCESS[Process Data]
    VALIDATE -->|Invalid| ERROR1[Display Validation Error]
    
    PROCESS --> CHECK{Availability Check}
    CHECK -->|Available| SAVE[Save Data]
    CHECK -->|Full| ERROR2[Display Full Error]
    
    SAVE --> CALENDAR[Create Calendar Event]
    CALENDAR -->|Success| SUCCESS[Display Success]
    CALENDAR -->|Error| ERROR3[Display Calendar Error]
    
    ERROR1 --> RETRY[Allow Retry]
    ERROR2 --> RETRY
    ERROR3 --> RETRY
    RETRY --> INPUT
```

## 7. テスト構成図

```mermaid
graph TB
    subgraph "Test Framework"
        ADAPTER[GasMochaAdapter]
        DESCRIBE[describe() functions]
        IT[it() test cases]
        ASSERT[assert() validations]
    end
    
    subgraph "Test Cases"
        TC1[parseStartTime Tests]
        TC2[isTimeSlotFull Tests]
        TC3[convertSpreadsheetDate Tests]
        TC4[calculateEndTime Tests]
    end
    
    ADAPTER --> DESCRIBE
    DESCRIBE --> IT
    IT --> ASSERT
    IT --> TC1
    IT --> TC2
    IT --> TC3
    IT --> TC4
```

## 8. セキュリティ構成

```mermaid
graph LR
    subgraph "Input Security"
        IS1[HTML5 Validation]
        IS2[JavaScript Validation]
        IS3[Server-side Validation]
    end
    
    subgraph "Data Security"
        DS1[HTTPS Communication]
        DS2[Google OAuth]
        DS3[Script Properties]
    end
    
    subgraph "Access Control"
        AC1[Email Requirement]
        AC2[GAS Execution Permissions]
        AC3[Spreadsheet Access Control]
    end
    
    IS1 --> DS1
    IS2 --> DS2
    IS3 --> DS3
    DS1 --> AC1
    DS2 --> AC2
    DS3 --> AC3
```

## 9. 設定管理構成

```mermaid
graph TB
    subgraph "Script Properties"
        SP1[SPREADSHEET_ID]
        SP2[CALENDAR_ID]
        SP3[RECEPTION_URL]
    end
    
    subgraph "Application Configuration"
        AC1[Facility Capacity]
        AC2[Operating Hours]
        AC3[Time Slots]
    end
    
    subgraph "External Resources"
        ER1[Materialize CSS CDN]
        ER2[Google Fonts]
        ER3[Material Icons]
    end
    
    SP1 --> AC1
    SP2 --> AC2
    SP3 --> AC3
    AC1 --> ER1
    AC2 --> ER2
    AC3 --> ER3
```

## 10. 監視・ログ構成

```mermaid
graph TD
    subgraph "Logging Points"
        LP1[Form Submission]
        LP2[Data Processing]
        LP3[Error Occurrences]
        LP4[Calendar Operations]
    end
    
    subgraph "Log Storage"
        LS1[Apps Script Logger]
        LS2[Stackdriver Logging]
    end
    
    subgraph "Monitoring"
        M1[Execution Time]
        M2[Error Rate]
        M3[Success Rate]
    end
    
    LP1 --> LS1
    LP2 --> LS1
    LP3 --> LS2
    LP4 --> LS1
    LS1 --> M1
    LS2 --> M2
    M1 --> M3
```
