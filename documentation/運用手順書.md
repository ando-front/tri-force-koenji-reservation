# Tri-force Koenji施設予約システム 運用手順書

## 1. 運用概要

### 1.1 運用体制
- **システム管理者**: 1名（全体管理・緊急対応）
- **運用担当者**: 1名（日常運用・監視）
- **利用者サポート**: 1名（問い合わせ対応）

### 1.2 運用時間
- **システム稼働時間**: 24時間365日
- **サポート時間**: 平日 9:00-18:00
- **メンテナンス時間**: 毎月第3日曜日 2:00-4:00

### 1.3 運用環境
- **本番環境**: Google Apps Script（メインシステム）
- **開発環境**: Google Apps Script（テスト用）
- **データストレージ**: Google Spreadsheet + Google Calendar

## 2. 日常運用手順

### 2.1 システム監視

#### 2.1.1 日次チェック項目
```bash
# 毎日9:00に実施
□ システム稼働状況確認
□ エラーログ確認
□ 予約データ整合性確認
□ 利用状況確認
□ バックアップ状況確認
```

#### 2.1.2 監視コマンド
```javascript
// Google Apps Script実行ログ確認
function checkSystemStatus() {
  const logs = console.log('システム状態確認開始');
  // 実行制限チェック
  const triggers = ScriptApp.getTriggers();
  Logger.log('アクティブトリガー数: ' + triggers.length);
  
  // スプレッドシートアクセス確認
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const lastRow = ss.getSheetByName('フォームの回答 2').getLastRow();
  Logger.log('最新データ行: ' + lastRow);
}
```

#### 2.1.3 アラート設定
- **実行エラー**: 即座に通知
- **応答時間**: 5秒以上で警告
- **データ異常**: 1時間以内に通知

### 2.2 データ管理

#### 2.2.1 バックアップ運用
```bash
# 日次バックアップ（自動）
* 2 * * * /usr/bin/google-drive-backup.sh

# 週次バックアップ（手動確認）
□ スプレッドシートのエクスポート
□ カレンダーデータのエクスポート
□ 設定情報のバックアップ
```

#### 2.2.2 データ整合性チェック
```javascript
// データ整合性チェック関数
function checkDataIntegrity() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const data = sheet.getDataRange().getValues();
  
  let errorCount = 0;
  for (let i = 1; i < data.length; i++) {
    // 必須項目チェック
    if (!data[i][1] || !data[i][2] || !data[i][3]) {
      Logger.log('データ不整合: 行' + (i + 1));
      errorCount++;
    }
  }
  
  return errorCount;
}
```

### 2.3 パフォーマンス監視

#### 2.3.1 性能指標
- **応答時間**: 平均3秒以下
- **エラー率**: 1%以下
- **可用性**: 99.5%以上

#### 2.3.2 パフォーマンス測定
```javascript
// 実行時間測定
function measurePerformance() {
  const startTime = new Date();
  
  // 処理実行
  processFormData(sampleData);
  
  const endTime = new Date();
  const executionTime = endTime - startTime;
  
  Logger.log('実行時間: ' + executionTime + 'ms');
  return executionTime;
}
```

## 3. 週次運用手順

### 3.1 週次チェック項目
```bash
# 毎週月曜日9:00に実施
□ システム全体の稼働状況確認
□ 週間利用統計の作成
□ 容量使用状況確認
□ セキュリティログ確認
□ パフォーマンス分析
```

### 3.2 利用統計作成
```javascript
// 週間利用統計
function createWeeklyReport() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const data = sheet.getDataRange().getValues();
  
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  
  let weeklyCount = 0;
  let facilityCount = {
    'フリーマット': 0,
    'フィットネス': 0
  };
  
  for (let i = 1; i < data.length; i++) {
    const timestamp = new Date(data[i][0]);
    if (timestamp >= weekAgo) {
      weeklyCount++;
      facilityCount[data[i][2]]++;
    }
  }
  
  Logger.log('週間予約数: ' + weeklyCount);
  Logger.log('施設別利用: ' + JSON.stringify(facilityCount));
}
```

### 3.3 容量管理
```javascript
// スプレッドシート容量確認
function checkStorageCapacity() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const lastRow = sheet.getLastRow();
  
  // 警告閾値: 450万行（500万行の90%）
  const WARNING_THRESHOLD = 4500000;
  
  if (lastRow > WARNING_THRESHOLD) {
    Logger.log('警告: スプレッドシート容量が限界に近づいています');
    // アラート送信処理
  }
}
```

## 4. 月次運用手順

### 4.1 月次メンテナンス
```bash
# 毎月第3日曜日 2:00-4:00
□ システム全体の詳細チェック
□ 古いデータのアーカイブ
□ システム設定の見直し
□ セキュリティ更新
□ パフォーマンス最適化
```

### 4.2 データアーカイブ
```javascript
// 古いデータのアーカイブ
function archiveOldData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const data = sheet.getDataRange().getValues();
  
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  
  const archiveData = [];
  const keepData = [data[0]]; // ヘッダー行
  
  for (let i = 1; i < data.length; i++) {
    const timestamp = new Date(data[i][0]);
    if (timestamp < threeMonthsAgo) {
      archiveData.push(data[i]);
    } else {
      keepData.push(data[i]);
    }
  }
  
  // アーカイブシート作成
  if (archiveData.length > 0) {
    const archiveSheet = ss.insertSheet('アーカイブ_' + Utilities.formatDate(new Date(), 'JST', 'yyyyMM'));
    archiveSheet.getRange(1, 1, archiveData.length, archiveData[0].length).setValues(archiveData);
  }
  
  // 元シートの更新
  sheet.clear();
  sheet.getRange(1, 1, keepData.length, keepData[0].length).setValues(keepData);
}
```

### 4.3 システム設定見直し
```javascript
// 設定値の確認・更新
function reviewSystemSettings() {
  const properties = PropertiesService.getScriptProperties();
  const settings = properties.getProperties();
  
  // 必要な設定項目の確認
  const requiredSettings = ['SPREADSHEET_ID', 'CALENDAR_ID', 'RECEPTION_URL'];
  
  for (const setting of requiredSettings) {
    if (!settings[setting]) {
      Logger.log('警告: 設定項目が未設定です - ' + setting);
    }
  }
  
  // 設定値の妥当性チェック
  try {
    SpreadsheetApp.openById(settings.SPREADSHEET_ID);
    CalendarApp.getCalendarById(settings.CALENDAR_ID);
  } catch (e) {
    Logger.log('エラー: 設定値が無効です - ' + e.message);
  }
}
```

## 5. 障害対応手順

### 5.1 障害レベル定義
- **レベル1**: システム完全停止
- **レベル2**: 機能一部停止
- **レベル3**: 性能劣化
- **レベル4**: 軽微な不具合

### 5.2 障害対応フロー
```bash
# 障害発生時の対応手順
1. 障害検知・確認
2. 影響範囲の特定
3. 緊急連絡（レベル1-2の場合）
4. 一次対応の実施
5. 原因調査・恒久対策
6. 復旧作業
7. 動作確認
8. 報告書作成
```

### 5.3 緊急時連絡先
```
システム管理者: [連絡先]
運用担当者: [連絡先]
Google Workspace管理者: [連絡先]
```

### 5.4 復旧手順

#### 5.4.1 スプレッドシート復旧
```bash
1. Google Driveのバージョン履歴から復元
2. バックアップファイルからのインポート
3. データ整合性の確認
4. 権限設定の確認
```

#### 5.4.2 Google Apps Script復旧
```bash
1. バックアップからのコード復元
2. 設定値の再設定
3. トリガーの再設定
4. 権限の再付与
```

## 6. セキュリティ運用

### 6.1 セキュリティチェック
```bash
# 月次セキュリティチェック
□ アクセス権限の確認
□ 不審なアクセスログの確認
□ パスワード・認証情報の更新
□ 脆弱性情報の確認
```

### 6.2 アクセス制御
```javascript
// 異常アクセスの検知
function detectAbnormalAccess() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const data = sheet.getDataRange().getValues();
  
  // 短時間での大量アクセス検知
  const oneHourAgo = new Date();
  oneHourAgo.setHours(oneHourAgo.getHours() - 1);
  
  let recentCount = 0;
  const ipCount = {};
  
  for (let i = 1; i < data.length; i++) {
    const timestamp = new Date(data[i][0]);
    if (timestamp >= oneHourAgo) {
      recentCount++;
    }
  }
  
  // 異常値の判定（1時間で100件以上）
  if (recentCount > 100) {
    Logger.log('警告: 異常なアクセス数を検知しました');
    // アラート送信処理
  }
}
```

## 7. 利用者サポート

### 7.1 問い合わせ対応
```bash
# 問い合わせ分類
□ 予約操作に関する質問
□ システム不具合の報告
□ 新機能の要望
□ アカウント・権限に関する問題
```

### 7.2 よくある質問と回答
```markdown
Q: 予約が取れない
A: 定員に達している可能性があります。カレンダーで空き状況を確認してください。

Q: 予約をキャンセルしたい
A: 現在のシステムではキャンセル機能はありません。管理者にご連絡ください。

Q: 過去の予約履歴を確認したい
A: 管理者にお問い合わせください。
```

### 7.3 サポート対応ログ
```javascript
// サポート対応の記録
function logSupportRequest(category, description, resolution) {
  const ss = SpreadsheetApp.openById(SUPPORT_LOG_SPREADSHEET_ID);
  const sheet = ss.getSheetByName('サポートログ');
  
  sheet.appendRow([
    new Date(),
    category,
    description,
    resolution,
    Session.getActiveUser().getEmail()
  ]);
}
```

## 8. 継続的改善

### 8.1 KPI監視
```javascript
// KPI計測
function calculateKPIs() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('フォームの回答 2');
  const data = sheet.getDataRange().getValues();
  
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  let totalReservations = 0;
  let successfulReservations = 0;
  
  for (let i = 1; i < data.length; i++) {
    const timestamp = new Date(data[i][0]);
    if (timestamp >= thirtyDaysAgo) {
      totalReservations++;
      if (data[i][8] !== 'エラー') { // エラーフラグがない場合
        successfulReservations++;
      }
    }
  }
  
  const successRate = (successfulReservations / totalReservations) * 100;
  Logger.log('予約成功率: ' + successRate.toFixed(2) + '%');
  
  return {
    totalReservations: totalReservations,
    successRate: successRate
  };
}
```

### 8.2 改善提案
```bash
# 月次改善レビュー
□ 利用者フィードバックの分析
□ システム性能の評価
□ 機能追加の検討
□ 運用プロセスの見直し
```

## 9. 災害対策

### 9.1 BCP（事業継続計画）
```bash
# 災害時の対応手順
1. 被害状況の確認
2. 代替手段の検討
3. 利用者への告知
4. 復旧作業の実施
5. 正常運用の再開
```

### 9.2 バックアップ・リストア
```javascript
// 緊急時バックアップ
function emergencyBackup() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const backup = ss.copy('緊急バックアップ_' + Utilities.formatDate(new Date(), 'JST', 'yyyyMMdd_HHmmss'));
  
  // バックアップファイルの共有設定
  DriveApp.getFileById(backup.getId()).setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  Logger.log('緊急バックアップ完了: ' + backup.getId());
}
```

## 10. 運用マニュアル更新

### 10.1 文書管理
```bash
# 運用マニュアルの更新履歴
□ 更新日時の記録
□ 更新内容の記録
□ 更新者の記録
□ 承認者の記録
```

### 10.2 教育・研修
```bash
# 新任者向け研修
□ システム概要の説明
□ 運用手順の説明
□ 障害対応の訓練
□ セキュリティ研修
```

---

**注意**: 本運用手順書は標準的な運用フローを示しています。実際の運用状況に応じて適宜見直し・更新を行ってください。
