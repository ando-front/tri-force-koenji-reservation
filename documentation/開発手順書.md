# Tri-force Koenji施設予約システム 開発手順書

## 1. 開発環境構築

### 1.1 前提条件チェック
```bash
# Node.js バージョン確認
node --version  # v12.0.0以上であることを確認

# npm バージョン確認
npm --version

# Git バージョン確認
git --version
```

### 1.2 Google Apps Script環境準備

#### 1.2.1 Google Apps Script APIの有効化
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択または新規作成
3. 「APIとサービス」→「ライブラリ」
4. 「Google Apps Script API」を検索して有効化

#### 1.2.2 認証設定
1. 「APIとサービス」→「認証情報」
2. 「認証情報を作成」→「OAuth 2.0 クライアント ID」
3. アプリケーションの種類：「デスクトップアプリケーション」
4. 認証情報をダウンロード

### 1.3 CLASPセットアップ
```bash
# CLASPグローバルインストール
npm install -g @google/clasp

# CLASPログイン
clasp login

# プロジェクトのクローン
git clone [リポジトリURL]
cd tri-force-koenji-reservation

# 依存関係のインストール
npm install
```

### 1.4 設定ファイル作成

#### 1.4.1 .clasp.json設定（開発環境）
```json
{
  "scriptId": "YOUR_DEVELOPMENT_SCRIPT_ID",
  "rootDir": "./dist"
}
```

#### 1.4.2 .clasp-prod.json設定（本番環境）
```json
{
  "scriptId": "YOUR_PRODUCTION_SCRIPT_ID",
  "rootDir": "./dist"
}
```

#### 1.4.3 .env設定（ローカル開発用）
```env
# Google Spreadsheet設定
SPREADSHEET_ID=your_spreadsheet_id
CALENDAR_ID=your_calendar_id
RECEPTION_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

## 2. 開発ワークフロー

### 2.1 開発開始手順
```bash
# 最新版の取得
git pull origin main

# 開発ブランチの作成
git checkout -b feature/your-feature-name

# 開発環境での作業開始
npm run clean
npm run build
```

### 2.2 コーディング規約

#### 2.2.1 JavaScript/Google Apps Script
- インデント：2スペース
- セミコロン：必須
- 関数名：camelCase
- 定数：UPPER_SNAKE_CASE
- コメント：JSDocスタイル

```javascript
/**
 * 予約データを処理する関数
 * @param {Object} formData - フォームデータ
 * @return {ContentService} - 処理結果
 */
function processFormData(formData) {
  // 処理内容
}
```

#### 2.2.2 HTML/CSS
- インデント：2スペース
- HTML属性：ダブルクォート
- CSS命名：BEM記法推奨

### 2.3 テスト実行
```bash
# 単体テスト実行
npm run test

# コード品質チェック
npm run lint

# テストカバレッジ確認
npm run test:coverage
```

### 2.4 ビルド・デプロイ
```bash
# 開発環境ビルド
npm run build

# 開発環境デプロイ
npm run deploy

# 本番環境デプロイ
npm run deploy:prod
```

## 3. Git運用手順

### 3.1 ブランチ戦略
```
main              # 本番環境
├── develop       # 開発環境
├── feature/*     # 機能開発
├── bugfix/*      # バグ修正
└── hotfix/*      # 緊急修正
```

### 3.2 コミットメッセージ規約
```
feat: 新機能追加
fix: バグ修正
docs: ドキュメント更新
style: コードスタイル修正
refactor: リファクタリング
test: テスト追加・修正
chore: その他の変更
```

### 3.3 プルリクエスト手順
1. 機能開発完了後
2. テスト実行・確認
3. プルリクエスト作成
4. コードレビュー
5. マージ承認・実行

## 4. デバッグ手順

### 4.1 ローカルデバッグ
```bash
# デバッグモードでビルド
npm run build:debug

# ログレベル設定
export LOG_LEVEL=DEBUG

# デバッグ実行
npm run debug
```

### 4.2 Google Apps Scriptデバッグ
1. Google Apps Script エディタでスクリプトを開く
2. 関数を選択して「デバッグ」ボタンをクリック
3. ブレークポイントを設定
4. 実行して変数を確認

### 4.3 ログ確認
```javascript
// ログ出力例
Logger.log('デバッグ情報: ' + JSON.stringify(data));
console.log('コンソール出力: ' + message);
```

### 4.4 エラー対応フロー
1. エラーログの確認
2. エラーの再現
3. 原因の特定
4. 修正の実装
5. テストによる確認
6. デプロイ

## 5. パフォーマンスチューニング

### 5.1 Google Apps Script最適化
```javascript
// 悪い例：繰り返しAPI呼び出し
for (let i = 0; i < data.length; i++) {
  sheet.getRange(i + 1, 1).setValue(data[i]);
}

// 良い例：バッチ処理
const values = data.map(item => [item]);
sheet.getRange(1, 1, values.length, 1).setValues(values);
```

### 5.2 スプレッドシート最適化
- 必要な範囲のみ読み込み
- バッチ処理の活用
- 不要な数式の削除

### 5.3 フロントエンド最適化
- 画像の最適化
- CSSの最小化
- JavaScriptの最適化

## 6. セキュリティ対策

### 6.1 認証・認可
- OAuth 2.0認証の実装
- スコープの最小化
- 定期的なトークンの更新

### 6.2 データ保護
- 機密データの暗号化
- 入力値のサニタイズ
- SQLインジェクション対策

### 6.3 セキュリティチェック
```bash
# 脆弱性チェック
npm audit

# セキュリティ修正
npm audit fix
```

## 7. 品質管理

### 7.1 コード品質チェック
```bash
# ESLint実行
npm run lint

# Prettier実行
npm run format

# 型チェック
npm run type-check
```

### 7.2 テスト品質管理
- テストカバレッジ：80%以上
- 単体テスト：全関数
- 結合テスト：主要フロー
- E2Eテスト：ユーザーシナリオ

### 7.3 コードレビュー基準
- 機能要件の満足
- 非機能要件の考慮
- コーディング規約の遵守
- テストの充実度
- ドキュメントの更新

## 8. リリース管理

### 8.1 バージョン管理
```bash
# バージョン更新
npm version patch  # 1.0.0 → 1.0.1
npm version minor  # 1.0.0 → 1.1.0
npm version major  # 1.0.0 → 2.0.0
```

### 8.2 リリースチェックリスト
- [ ] 全テストの実行・成功確認
- [ ] コード品質チェック
- [ ] セキュリティチェック
- [ ] ドキュメント更新
- [ ] バックアップ作成
- [ ] 本番環境デプロイ
- [ ] 動作確認
- [ ] リリースノート作成

### 8.3 ロールバック手順
1. 問題の確認・切り分け
2. 影響範囲の特定
3. 前バージョンへの復元
4. 動作確認
5. インシデント報告

## 9. 緊急時対応

### 9.1 障害対応フロー
1. 障害検知
2. 影響範囲の確認
3. 一次対応（システム停止など）
4. 原因調査
5. 恒久対策
6. 再発防止策

### 9.2 連絡体制
- 開発責任者
- システム管理者
- 利用者代表
- 関係者への連絡

### 9.3 復旧手順
1. バックアップからの復元
2. データ整合性の確認
3. 機能テストの実行
4. 段階的なサービス再開

## 10. 開発ツール

### 10.1 推奨開発環境
- **IDE**: Visual Studio Code
- **拡張機能**:
  - Google Apps Script
  - ESLint
  - Prettier
  - GitLens

### 10.2 便利なコマンド
```bash
# 開発用ショートカット
alias gas-dev="npm run build && npm run deploy"
alias gas-prod="npm run build && npm run deploy:prod"
alias gas-test="npm run test && npm run lint"
```

### 10.3 デバッグツール
- Chrome DevTools
- Google Apps Script エディタ
- Stackdriver Logging

## 11. トラブルシューティング

### 11.1 よくある問題と解決策

#### 11.1.1 CLASPログインエラー
```bash
# 認証情報をクリア
clasp logout
clasp login
```

#### 11.1.2 デプロイエラー
```bash
# 権限確認
clasp open --addon

# 設定確認
cat .clasp.json
```

#### 11.1.3 スプレッドシート接続エラー
```javascript
// 権限確認
DriveApp.getFileById(SPREADSHEET_ID);
```

### 11.2 パフォーマンス問題
- 実行時間制限（6分）の対策
- メモリ使用量の最適化
- API呼び出し回数の削減

### 11.3 Google Apps Script制限
- 日次実行制限
- 同時実行数制限
- トリガー数制限

---

**注意**: 本手順書は開発・運用の標準的な流れを示しています。プロジェクトの特性に応じて適宜調整してください。
